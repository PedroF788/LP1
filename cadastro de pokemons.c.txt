#include <stdio.h>
#include <stdlib.h>
#include <string.h>

/* -------------------- Estruturas -------------- */

// Defini√ß√£o da estrutura de dados do Pok√©mon
typedef struct pokemon {
    char nome[50];
    char elemento[50];
    int nivel;
} POKEMON;

// Defini√ß√£o da estrutura do N√≥ (Lista Duplamente Encadeada)
typedef struct nodo {
    POKEMON *pPokemon;      // Ponteiro para a estrutura de dados
    struct nodo *pProximo;  // Ponteiro para o pr√≥ximo n√≥
    struct nodo *pAnterior; // Ponteiro para o n√≥ anterior
} NODO;

/* --------- Vari√°veis globais (Ponteiros da Lista) --------------------- */

NODO *pInicio = NULL;
NODO *pFim = NULL;

/* --------------- Prot√≥tipos de Fun√ß√µes --------- */

void MenuPrincipal(void);
// Fun√ß√µes da Lista
NODO *CriaNovoNodo(void);
void InsereNoFim(NODO *novoNodo);
void RemovePokemonPorNome(void); // <--- NOVA FUN√á√ÉO
void LiberaLista(void);
// Fun√ß√µes de I/O
void ColetaDadosPokemon(POKEMON *pPokemon);
void ListaPokemon(void);
void SalvaLista(void);
void CarregaLista(void);
void Pausa(void);

/* ------------------ Fun√ß√£o Principal (Main) -------------- */

int main(void) {
    CarregaLista();
    MenuPrincipal();
    LiberaLista();
    return 0;
}

/* -------------------- Menu Principal (Visual Melhorado) ------------------- */

void MenuPrincipal(void) {
    int opcao = 0;
    
    do {
        system("clear || cls"); 
        printf("\n#################################################\n");
        printf("#             üåü P O K √â D E X üåü             #\n");
        printf("#################################################\n");
        printf(" 1. Cadastrar Novo Pok√©mon\n");
        printf(" 2. Listar Todos os Pok√©mons\n");
        printf(" 3. Remover Pok√©mon por Nome\n"); // <--- NOVA OP√á√ÉO
        printf(" 4. Salvar Lista no Arquivo\n");
        printf(" 5. Carregar Lista do Arquivo\n");
        printf(" 6. Sair\n");
        printf("-------------------------------------------------\n");
        printf(" Escolha uma op√ß√£o: ");
        
        if (scanf("%d", &opcao) != 1) {
            opcao = -1;
        }
        
        int c;
        while ((c = getchar()) != '\n' && c != EOF); // Limpa buffer

        switch (opcao) {
            case 1:
                InsereNoFim(CriaNovoNodo()); 
                Pausa();
                break;
            case 2:
                ListaPokemon();
                Pausa();
                break;
            case 3:
                RemovePokemonPorNome(); // <--- CHAMADA DA FUN√á√ÉO
                Pausa();
                break;
            case 4:
                SalvaLista();
                Pausa();
                break;
            case 5:
                LiberaLista();
                CarregaLista(); 
                Pausa();
                break;
            case 6:
                printf("\n Fim do Pok√©dex - At√© logo!\n");
                break;
            default:
                printf("\n Op√ß√£o inv√°lida! Pressione ENTER para tentar novamente.\n");
                Pausa();
                break;
        }
    } while (opcao != 6); // A condi√ß√£o de sa√≠da agora √© a op√ß√£o 6
}

/* ------------------- Fun√ß√µes de Aloca√ß√£o e Inser√ß√£o -------------------- */

NODO *CriaNovoNodo(void) {
    NODO *pNodoAtual = (NODO *)malloc(sizeof(NODO));
    POKEMON *pPokemonAtual = (POKEMON *)malloc(sizeof(POKEMON));

    if (pNodoAtual == NULL || pPokemonAtual == NULL) {
        printf("\n [ERRO] Mem√≥ria insuficiente. Cadastro falhou.\n");
        if (pNodoAtual) free(pNodoAtual);
        if (pPokemonAtual) free(pPokemonAtual);
        return NULL;
    }

    pNodoAtual->pPokemon = pPokemonAtual;
    pNodoAtual->pProximo = NULL;
    pNodoAtual->pAnterior = NULL;

    ColetaDadosPokemon(pNodoAtual->pPokemon);
    
    return pNodoAtual;
}

void InsereNoFim(NODO *novoNodo) {
    if (novoNodo == NULL) {
        return;
    }
    
    if (pInicio == NULL) {
        pInicio = novoNodo;
        pFim = novoNodo;
        printf("\n‚úÖ Pok√©mon %s cadastrado com sucesso (Primeiro da lista)!\n", novoNodo->pPokemon->nome);
    } 
    else {
        pFim->pProximo = novoNodo;
        novoNodo->pAnterior = pFim;
        pFim = novoNodo;
        printf("\n‚úÖ Pok√©mon %s cadastrado com sucesso!\n", novoNodo->pPokemon->nome);
    }
}

/* ------------------- Fun√ß√£o de Remo√ß√£o -------------------- */

void RemovePokemonPorNome(void) {
    char nomeBusca[50];
    NODO *pAtual = pInicio;
    
    if (pInicio == NULL) {
        printf("\n A lista est√° vazia. N√£o h√° Pok√©mons para remover.\n");
        return;
    }

    printf("\n --- Remover Pok√©mon ---\n");
    printf(" Digite o nome do Pok√©mon a ser removido: ");
    if (fgets(nomeBusca, sizeof(nomeBusca), stdin) != NULL) {
        nomeBusca[strcspn(nomeBusca, "\n")] = 0; // Remove '\n'
    } else {
        return;
    }

    // Procura o Pok√©mon na lista
    while (pAtual != NULL) {
        // Compara ignorando a caixa (case-insensitive)
        if (strcasecmp(pAtual->pPokemon->nome, nomeBusca) == 0) {
            
            // 1. O n√≥ a ser removido √© o √∫nico n√≥ (pInicio == pFim)
            if (pAtual == pInicio && pAtual == pFim) {
                pInicio = NULL;
                pFim = NULL;
            } 
            // 2. O n√≥ a ser removido √© o pInicio
            else if (pAtual == pInicio) {
                pInicio = pAtual->pProximo;
                pInicio->pAnterior = NULL;
            } 
            // 3. O n√≥ a ser removido √© o pFim
            else if (pAtual == pFim) {
                pFim = pAtual->pAnterior;
                pFim->pProximo = NULL;
            } 
            // 4. O n√≥ a ser removido est√° no meio
            else {
                pAtual->pAnterior->pProximo = pAtual->pProximo;
                pAtual->pProximo->pAnterior = pAtual->pAnterior;
            }

            // Libera a mem√≥ria
            printf("\n üî• Pok√©mon %s removido com sucesso (Adeus, velhos amigos)! üî•\n", pAtual->pPokemon->nome);
            free(pAtual->pPokemon);
            free(pAtual);
            return;
        }
        pAtual = pAtual->pProximo;
    }

    printf("\n [AVISO] Pok√©mon '%s' n√£o encontrado na Pok√©dex.\n", nomeBusca);
}


/* ------------------- Fun√ß√µes de I/O de Dados -------------------- */

void ColetaDadosPokemon(POKEMON *pPokemon) {
    system("clear || cls");
    printf("\n--- Novo Cadastro ---\n");
    
    printf(" Nome: ");
    if (fgets(pPokemon->nome, sizeof(pPokemon->nome), stdin) != NULL) {
        pPokemon->nome[strcspn(pPokemon->nome, "\n")] = 0; // Remove '\n'
    }

    printf(" Elemento (Fogo, √Ågua, etc.): ");
    if (fgets(pPokemon->elemento, sizeof(pPokemon->elemento), stdin) != NULL) {
        pPokemon->elemento[strcspn(pPokemon->elemento, "\n")] = 0; // Remove '\n'
    }

    printf(" N√≠vel: ");
    if (scanf("%d", &(pPokemon->nivel)) != 1) {
         printf("[AVISO] N√≠vel inv√°lido. Definido para 0.\n");
         pPokemon->nivel = 0;
    }
    
    int c;
    while ((c = getchar()) != '\n' && c != EOF); // Limpa buffer
}

/* -------------------- Fun√ß√µes de Visualiza√ß√£o e Persist√™ncia ------------------- */

void ListaPokemon(void) {
    NODO *pAtual = pInicio;
    
    system("clear || cls");
    printf("\n=================================================\n");
    printf("               üìú LISTA DE POK√âMONS üìú             \n");
    printf("=================================================\n");
    
    if (pInicio == NULL) {
        printf("\n A Pok√©dex est√° vazia. Cadastre o primeiro Pok√©mon!\n");
        return;
    }
    
    int contador = 1;
    while (pAtual != NULL) {
        printf("\n--- [%03d] - %s ---\n", contador, pAtual->pPokemon->nome);
        printf(" | Elemento: %s\n", pAtual->pPokemon->elemento);
        printf(" | N√≠vel:    %d\n", pAtual->pPokemon->nivel);
        pAtual = pAtual->pProximo;
        contador++;
    }
    printf("-------------------------------------------------\n");
    printf(" ‚û°Ô∏è Total de Pok√©mons na Pok√©dex: %d\n", contador - 1);
}

void SalvaLista(void) {
    FILE *arquivo = fopen("pokemons.dat", "wb");
    if (arquivo == NULL) {
        printf("\n [ERRO] N√£o foi poss√≠vel abrir o arquivo para salvar.\n");
        return;
    }
    
    NODO *pAtual = pInicio;
    int totalSalvo = 0;
    
    while (pAtual != NULL) {
        fwrite(pAtual->pPokemon, sizeof(POKEMON), 1, arquivo);
        pAtual = pAtual->pProximo;
        totalSalvo++;
    }
    
    fclose(arquivo);
    printf("\n ‚úÖ Sucesso! %d Pok√©mons salvos em 'pokemons.dat'.\n", totalSalvo);
}

void CarregaLista(void) {
    FILE *arquivo = fopen("pokemons.dat", "rb");
    if (arquivo == NULL) {
        printf("\n ‚ö†Ô∏è Arquivo de dados 'pokemons.dat' n√£o encontrado. Iniciando lista vazia.\n");
        return;
    }
    
    POKEMON tempPokemon;
    int totalCarregado = 0;
    
    while (fread(&tempPokemon, sizeof(POKEMON), 1, arquivo) == 1) {
        NODO *novoNodo = (NODO *)malloc(sizeof(NODO));
        POKEMON *pPokemonAtual = (POKEMON *)malloc(sizeof(POKEMON));
        
        if (novoNodo == NULL || pPokemonAtual == NULL) {
            printf("\n [ERRO] Falha de mem√≥ria durante o carregamento. Interrompido.\n");
            break;
        }

        *(pPokemonAtual) = tempPokemon;
        
        novoNodo->pPokemon = pPokemonAtual;
        novoNodo->pProximo = NULL;
        novoNodo->pAnterior = pFim;
        
        if (pInicio == NULL) {
            pInicio = novoNodo;
        } else {
            pFim->pProximo = novoNodo;
        }
        pFim = novoNodo;
        totalCarregado++;
    }
    
    fclose(arquivo);
    printf("\n ‚úÖ %d Pok√©mons carregados do arquivo 'pokemons.dat'.\n", totalCarregado);
}

/* ---------------------- Libera Mem√≥ria ---------------------------- */

void LiberaLista(void) {
    NODO *pAtual = pInicio;
    NODO *pTemp;
    
    while (pAtual != NULL) {
        pTemp = pAtual->pProximo;
        free(pAtual->pPokemon);
        free(pAtual);
        pAtual = pTemp;
    }
    
    pInicio = NULL;
    pFim = NULL;
}

void Pausa(void) {
    printf("\n Pressione ENTER para continuar...");
    getchar();
}